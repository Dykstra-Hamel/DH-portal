<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DH Widget Test - Paste & Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f8fafc;
        color: #334155;
        line-height: 1.6;
      }
      
      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #3b82f6, #1e40af);
        color: white;
        border-radius: 12px;
      }
      
      .header h1 {
        margin: 0 0 10px 0;
        font-size: 2rem;
        font-weight: 700;
      }
      
      .header p {
        margin: 0;
        opacity: 0.9;
      }
      
      .test-section {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        margin-bottom: 30px;
      }
      
      .test-section h2 {
        margin: 0 0 20px 0;
        color: #1e293b;
        font-size: 1.3rem;
        font-weight: 600;
      }
      
      .code-input {
        width: 100%;
        min-height: 120px;
        padding: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 14px;
        background: #f8fafc;
        resize: vertical;
        margin-bottom: 15px;
      }
      
      .code-input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
      }
      
      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      
      .btn-primary {
        background: #3b82f6;
        color: white;
      }
      
      .btn-primary:hover {
        background: #2563eb;
      }
      
      .btn-secondary {
        background: #64748b;
        color: white;
      }
      
      .btn-secondary:hover {
        background: #475569;
      }
      
      .btn-danger {
        background: #dc2626;
        color: white;
      }
      
      .btn-danger:hover {
        background: #b91c1c;
      }
      
      .example-codes {
        background: #f1f5f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .example-codes h3 {
        margin: 0 0 15px 0;
        color: #374151;
        font-size: 1.1rem;
      }
      
      .example-code {
        background: white;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 4px solid #3b82f6;
      }
      
      .example-code h4 {
        margin: 0 0 8px 0;
        font-size: 0.9rem;
        color: #374151;
      }
      
      .example-code code {
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 12px;
        color: #1e293b;
        display: block;
        white-space: pre-wrap;
        word-break: break-all;
      }
      
      .example-code button {
        margin-top: 8px;
        padding: 4px 8px;
        font-size: 12px;
        background: #e2e8f0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      
      .example-code button:hover {
        background: #cbd5e1;
      }
      
      .widget-container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        border: 2px dashed #cbd5e1;
        margin: 20px 0;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
      }
      
      .debug-console {
        background: #1e293b;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      
      .status-message {
        padding: 10px 15px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 500;
      }
      
      .status-success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }
      
      .status-error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üß™ DH Widget Test</h1>
      <p>Paste any widget embed code and test it instantly</p>
    </div>

    <div class="test-section">
      <h2>üìù Paste & Test Widget Code</h2>
      
      <div class="example-codes">
        <h3>Quick Examples (click to use):</h3>
        
        <div class="example-code">
          <h4>üìÑ Inline Widget (Default)</h4>
          <code id="example-inline">&lt;script 
  src="/widget.js"
  data-company-id="22222222-2222-2222-2222-222222222222"
  data-base-url="http://localhost:3000"
&gt;&lt;/script&gt;</code>
          <button onclick="useExample('example-inline')">Use This</button>
        </div>
        
        <div class="example-code">
          <h4>üîò Button + Modal Widget</h4>
          <code id="example-button">&lt;script 
  src="/widget.js"
  data-company-id="22222222-2222-2222-2222-222222222222"
  data-base-url="http://localhost:3000"
  data-display-mode="button"
  data-button-text="Get Free Quote"
&gt;&lt;/script&gt;</code>
          <button onclick="useExample('example-button')">Use This</button>
        </div>
        
        <div class="example-code">
          <h4>üé® Custom Styled Widget</h4>
          <code id="example-custom">&lt;script 
  src="/widget.js"
  data-company-id="22222222-2222-2222-2222-222222222222"
  data-base-url="http://localhost:3000"
  data-header-text="Get Your Custom Quote"
  data-primary-color="#ff6b35"
  data-background-color="#f9fafb"
&gt;&lt;/script&gt;</code>
          <button onclick="useExample('example-custom')">Use This</button>
        </div>
      </div>
      
      <textarea 
        id="widget-code" 
        class="code-input" 
        placeholder="Paste your widget embed code here...

Example:
<script 
  src=&quot;/widget.js&quot;
  data-company-id=&quot;your-company-id&quot;
  data-base-url=&quot;http://localhost:3000&quot;
></script>"
      ></textarea>
      
      <div class="button-group">
        <button class="btn btn-primary" onclick="testWidget()">üöÄ Test Widget</button>
        <button class="btn btn-secondary" onclick="clearWidget()">üßπ Clear</button>
        <button class="btn btn-danger" onclick="resetPage()">üîÑ Reset Page</button>
      </div>
      
      <div id="status-message"></div>
    </div>

    <div class="test-section">
      <h2>üì± Widget Output</h2>
      <div class="widget-container" id="widget-container">
        <p>Paste widget code above and click "Test Widget" to see it here</p>
      </div>
    </div>

    <div class="test-section">
      <h2>üîç Debug Console</h2>
      <div class="debug-console" id="debug-console">
        <div id="debug-output">Ready for testing...</div>
      </div>
    </div>

    <script>
      let widgetCounter = 0;

      // Debug logging function
      function debugLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const debugOutput = document.getElementById('debug-output');
        const logLine = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
        
        console.log(logLine);
        if (debugOutput) {
          debugOutput.innerHTML += logLine + '\n';
          debugOutput.scrollTop = debugOutput.scrollHeight;
        }
      }

      // Show status message
      function showStatus(message, type = 'success') {
        const statusDiv = document.getElementById('status-message');
        statusDiv.className = `status-message status-${type}`;
        statusDiv.textContent = message;
        
        setTimeout(() => {
          statusDiv.textContent = '';
          statusDiv.className = '';
        }, 5000);
      }

      // Use example code
      function useExample(exampleId) {
        const exampleCode = document.getElementById(exampleId).textContent;
        document.getElementById('widget-code').value = exampleCode;
        debugLog(`Loaded example: ${exampleId}`);
      }

      // Test widget function
      function testWidget() {
        const code = document.getElementById('widget-code').value.trim();
        const container = document.getElementById('widget-container');
        
        if (!code) {
          showStatus('Please paste widget code first', 'error');
          return;
        }
        
        debugLog('Testing new widget code...');
        
        // Clear existing widget state
        if (window.DHWidgetLoaded) {
          delete window.DHWidgetLoaded;
          debugLog('Cleared previous widget state');
        }
        
        // Clear container
        container.innerHTML = '<p style="color: #64748b;">Loading widget...</p>';
        
        // Remove any existing modals
        const existingModals = document.querySelectorAll('.dh-modal-overlay');
        existingModals.forEach(modal => modal.remove());
        
        try {
          // Create a temporary div to parse the HTML
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = code;
          
          const scriptTag = tempDiv.querySelector('script');
          if (!scriptTag) {
            throw new Error('No script tag found in the provided code');
          }
          
          // Create new script element
          const newScript = document.createElement('script');
          newScript.src = scriptTag.src || '/widget.js';
          
          // Copy all data attributes
          Array.from(scriptTag.attributes).forEach(attr => {
            if (attr.name.startsWith('data-')) {
              newScript.setAttribute(attr.name, attr.value);
            }
          });
          
          // Add container ID for proper placement
          newScript.setAttribute('data-container-id', 'widget-container');
          
          // Add unique identifier
          widgetCounter++;
          newScript.setAttribute('data-test-id', `test-${widgetCounter}`);
          
          // Error handling
          newScript.onerror = function() {
            debugLog('Failed to load widget script', 'error');
            container.innerHTML = '<p style="color: #dc2626;">‚ùå Failed to load widget</p>';
            showStatus('Widget failed to load', 'error');
          };
          
          newScript.onload = function() {
            debugLog('Widget script loaded successfully');
          };
          
          // Clear container and add script
          container.innerHTML = '';
          document.body.appendChild(newScript);
          
          debugLog(`Widget initialized with test ID: test-${widgetCounter}`);
          showStatus('Widget loaded successfully!', 'success');
          
        } catch (error) {
          debugLog(`Error parsing widget code: ${error.message}`, 'error');
          container.innerHTML = `<p style="color: #dc2626;">‚ùå Error: ${error.message}</p>`;
          showStatus(`Error: ${error.message}`, 'error');
        }
      }

      // Clear widget
      function clearWidget() {
        const container = document.getElementById('widget-container');
        container.innerHTML = '<p style="color: #64748b;">Paste widget code above and click "Test Widget" to see it here</p>';
        
        // Remove any existing modals
        const existingModals = document.querySelectorAll('.dh-modal-overlay');
        existingModals.forEach(modal => modal.remove());
        
        // Clear widget state
        if (window.DHWidgetLoaded) {
          delete window.DHWidgetLoaded;
        }
        
        debugLog('Widget cleared');
        showStatus('Widget cleared', 'success');
      }

      // Reset page
      function resetPage() {
        window.location.reload();
      }

      // Monitor for errors
      window.addEventListener('error', function(e) {
        debugLog(`JavaScript Error: ${e.message}`, 'error');
      });

      window.addEventListener('unhandledrejection', function(e) {
        debugLog(`Promise Rejection: ${e.reason}`, 'error');
      });

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        debugLog('Widget test page loaded and ready');
      });
    </script>
  </body>
</html>